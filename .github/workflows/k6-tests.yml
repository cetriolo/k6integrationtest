name: K6 Performance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
          - performance
          - auth-flow
          - file-operations
          - all

env:
  GO_VERSION: '1.25.1'
  K6_VERSION: 'v0.48.0'

jobs:
  build:
    name: Build e Test applicazione Go
    runs-on: ubuntu-latest
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build applicazione
        run: go build -o api-server main.go

      - name: Avvia server in background
        run: |
          ./api-server &
          echo $! > server.pid
          sleep 3

      - name: Test connettivitÃ  server
        run: curl http://localhost:8080/health

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-server
          path: api-server

      - name: Ferma server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
          fi

  smoke-test:
    name: Smoke Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'smoke' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: api-server

      - name: Rendi eseguibile il server
        run: chmod +x api-server

      - name: Avvia server
        run: |
          ./api-server &
          echo $! > server.pid
          sleep 3

      - name: Setup K6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/${{ env.K6_VERSION }}/k6-${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/

      - name: Esegui Smoke Test
        run: k6 run tests/smoke-test.js

      - name: Ferma server
        if: always()
        run: kill $(cat server.pid) || true

  load-test:
    name: Load Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'all'
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: api-server

      - name: Rendi eseguibile il server
        run: chmod +x api-server

      - name: Avvia server
        run: |
          ./api-server &
          echo $! > server.pid
          sleep 3

      - name: Setup K6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/${{ env.K6_VERSION }}/k6-${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/

      - name: Esegui Load Test
        run: k6 run tests/load-test.js

      - name: Ferma server
        if: always()
        run: kill $(cat server.pid) || true

  stress-test:
    name: Stress Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'stress' || github.event.inputs.test_type == 'all'
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: api-server

      - name: Rendi eseguibile il server
        run: chmod +x api-server

      - name: Avvia server
        run: |
          ./api-server &
          echo $! > server.pid
          sleep 3

      - name: Setup K6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/${{ env.K6_VERSION }}/k6-${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/

      - name: Esegui Stress Test
        run: k6 run tests/stress-test.js

      - name: Ferma server
        if: always()
        run: kill $(cat server.pid) || true

  performance-test:
    name: Performance Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'performance' || github.event.inputs.test_type == 'all'
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: api-server

      - name: Rendi eseguibile il server
        run: chmod +x api-server

      - name: Avvia server
        run: |
          ./api-server &
          echo $! > server.pid
          sleep 3

      - name: Setup K6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/${{ env.K6_VERSION }}/k6-${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/

      - name: Esegui Performance Test
        run: k6 run tests/performance-test.js

      - name: Upload report performance
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: performance-report.json

      - name: Ferma server
        if: always()
        run: kill $(cat server.pid) || true

  auth-flow-test:
    name: Auth Flow Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'auth-flow' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: api-server

      - name: Rendi eseguibile il server
        run: chmod +x api-server

      - name: Avvia server
        run: |
          ./api-server &
          echo $! > server.pid
          sleep 3

      - name: Setup K6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/${{ env.K6_VERSION }}/k6-${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/

      - name: Esegui Auth Flow Test
        run: k6 run tests/auth-flow-test.js

      - name: Ferma server
        if: always()
        run: kill $(cat server.pid) || true

  file-operations-test:
    name: File Operations Test
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'file-operations' || github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: api-server

      - name: Rendi eseguibile il server
        run: chmod +x api-server

      - name: Avvia server
        run: |
          ./api-server &
          echo $! > server.pid
          sleep 3

      - name: Setup K6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/${{ env.K6_VERSION }}/k6-${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/

      - name: Esegui File Operations Test
        run: k6 run tests/file-operations-test.js

      - name: Ferma server
        if: always()
        run: kill $(cat server.pid) || true

  # Job per test su ambiente remoto
  remote-test:
    name: Test su Ambiente Remoto
    runs-on: ubuntu-latest
    #if: github.ref == 'refs/heads/main' activate for main branch only
    if: github.event.inputs.test_type == 'remote'
    steps:
      - name: Checkout codice
        uses: actions/checkout@v4

      - name: Setup K6
        run: |
          curl -L https://github.com/grafana/k6/releases/download/${{ env.K6_VERSION }}/k6-${{ env.K6_VERSION }}-linux-amd64.tar.gz | tar xvz
          sudo mv k6-${{ env.K6_VERSION }}-linux-amd64/k6 /usr/local/bin/

      - name: Esegui Smoke Test su ambiente remoto
        env:
          BASE_URL: ${{ secrets.PROD_URL || 'https://your-app.example.com' }}
        run: k6 run -e BASE_URL=$BASE_URL tests/smoke-test.js